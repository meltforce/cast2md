{% extends "base.html" %}

{% block title %}Search - cast2md{% endblock %}

{% block content %}
<hgroup>
    <h1>Search</h1>
    <p>Search episodes and transcripts</p>
</hgroup>

<article style="margin-bottom: 1.5rem; padding: 1rem; background: var(--card-background-color);">
    <form id="search-form" method="get" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
        <div style="flex: 1; min-width: 250px;">
            <label for="searchQuery">Search query</label>
            <input type="text" id="searchQuery" name="q" value="{{ query }}"
                   placeholder="Enter search terms..." autofocus>
        </div>
        <div style="min-width: 180px;">
            <label for="feedFilter">Filter by feed</label>
            <select id="feedFilter" name="feed_id">
                <option value="">All feeds</option>
                {% for feed in feeds %}
                <option value="{{ feed.id }}" {% if feed_id == feed.id %}selected{% endif %}>{{ feed.display_title }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <button type="submit">Search</button>
        </div>
    </form>
    <details style="margin-top: 1rem;">
        <summary style="cursor: pointer; font-size: 0.875rem;">Search options</summary>
        <div style="padding: 0.5rem; font-size: 0.875rem; color: var(--muted-color);">
            <p style="margin: 0 0 0.5rem;"><strong>Search mode:</strong></p>
            <div style="margin-bottom: 0.75rem; display: flex; gap: 1.5rem; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.35rem; cursor: pointer;">
                    <input type="radio" name="mode" value="hybrid" {% if mode == 'hybrid' %}checked{% endif %} form="search-form">
                    <span>Hybrid (recommended)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.35rem; cursor: pointer;">
                    <input type="radio" name="mode" value="keyword" {% if mode == 'keyword' %}checked{% endif %} form="search-form">
                    <span>Keyword only</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.35rem; cursor: pointer;">
                    <input type="radio" name="mode" value="semantic" {% if mode == 'semantic' %}checked{% endif %} form="search-form">
                    <span>Semantic only</span>
                </label>
            </div>
            <p style="margin: 0 0 0.5rem;"><strong>Keyword syntax:</strong></p>
            <ul style="margin: 0;">
                <li><code>kubernetes</code> - Simple search</li>
                <li><code>"machine learning"</code> - Exact phrase</li>
                <li><code>python AND async</code> - Both terms required</li>
                <li><code>docker OR kubernetes</code> - Either term</li>
                <li><code>python NOT flask</code> - Exclude term</li>
            </ul>
        </div>
    </details>
</article>

<p style="font-size: 0.875rem; color: var(--muted-color);">
    Index: {{ index_stats.indexed_episodes }} episodes, {{ index_stats.total_segments }} segments
    {% if index_stats.embedded_episodes > 0 %}
        ({{ index_stats.embedded_episodes }} with embeddings)
    {% endif %}
    {% if query %}
        | Found <strong>{{ total }}</strong> result{{ 's' if total != 1 else '' }}
    {% endif %}
</p>

{% if query %}
    {% if results %}
    <div class="search-results">
        {% for result in results %}
        <article class="search-result" style="cursor: pointer;">
            <a href="/episodes/{{ result.episode_id }}?t={{ result.segment_start|int }}" style="text-decoration: none; color: inherit; display: block;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 0.5rem;">
                    <div style="flex: 1; min-width: 200px;">
                        <strong>{{ result.episode_title }}</strong>
                        <span style="color: var(--muted-color); font-size: 0.875rem;">
                            &mdash; {{ result.feed_title }}
                        </span>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        {% if result.published_at %}
                        <span style="font-size: 0.875rem; color: var(--muted-color);">
                            {{ result.published_at[:10] }}
                        </span>
                        {% endif %}
                        <div style="display: flex; gap: 0.25rem;">
                            <span class="match-badge match-{{ result.match_type }}">{{ result.match_type }}</span>
                        </div>
                    </div>
                </div>
                {% if result.text %}
                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--muted-color);">
                    {% set minutes = (result.segment_start|int) // 60 %}
                    {% set seconds = (result.segment_start|int) % 60 %}
                    <span class="match-timestamp" style="font-family: monospace; margin-right: 0.5rem;">[{{ '%02d'|format(minutes) }}:{{ '%02d'|format(seconds) }}]</span>
                    <span class="match-text">{{ result.text|truncate(200) }}</span>
                </div>
                {% endif %}
            </a>
        </article>
        {% endfor %}
    </div>

    {# Pagination #}
    {% if total_pages > 1 %}
    <nav style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1.5rem;">
        {% if page > 1 %}
        <a href="?q={{ query|urlencode }}{% if feed_id %}&feed_id={{ feed_id }}{% endif %}&mode={{ mode }}&page={{ page - 1 }}" role="button" class="outline">&larr; Previous</a>
        {% endif %}
        <span style="padding: 0.5rem 1rem; display: flex; align-items: center;">Page {{ page }} of {{ total_pages }}</span>
        {% if page < total_pages %}
        <a href="?q={{ query|urlencode }}{% if feed_id %}&feed_id={{ feed_id }}{% endif %}&mode={{ mode }}&page={{ page + 1 }}" role="button" class="outline">Next &rarr;</a>
        {% endif %}
    </nav>
    {% endif %}

    {% else %}
    <article style="text-align: center; padding: 3rem;">
        <p>No results found for "<strong>{{ query }}</strong>"</p>
        <p style="color: var(--muted-color);">Try different search terms.</p>
    </article>
    {% endif %}

{% else %}
<article style="text-align: center; padding: 3rem;">
    <p>Enter a search query to find episodes and transcripts.</p>
    <p style="color: var(--muted-color);">
        {% if index_stats.indexed_episodes == 0 %}
        No transcripts indexed yet. Run <code>cast2md reindex-transcripts</code> to index existing transcripts.
        {% else %}
        Search across {{ index_stats.indexed_episodes }} transcribed episodes.
        {% endif %}
    </p>
</article>
{% endif %}

<!-- Episode Detail Modal -->
<dialog id="episodeDetailModal">
    <article class="modal-content">
        <header class="modal-header">
            <div>
                <h3 id="modalTitle" style="margin: 0;"></h3>
                <p id="modalMeta" style="margin: 0.25rem 0 0; color: var(--muted-color); font-size: 0.875rem;"></p>
            </div>
            <button class="close-btn" onclick="closeEpisodeModal()" aria-label="Close">&times;</button>
        </header>

        <div id="modalLoading" style="text-align: center; padding: 2rem;">
            <p>Loading...</p>
        </div>

        <div id="modalBody" style="display: none;">
            <section class="modal-section">
                <h4>Show Notes</h4>
                <div id="modalShowNotes" class="shownotes-container"></div>
            </section>

            <section id="transcriptSection" class="modal-section">
                <h4>Transcript Matches (<span id="transcriptMatchCount">0</span>)</h4>
                <div id="modalTranscriptMatches" class="transcript-matches"></div>
            </section>
        </div>

        <footer class="modal-footer">
            <a id="modalEpisodeLink" href="#" role="button">Open Full Episode</a>
        </footer>
    </article>
</dialog>

<script>
let lastScrollPosition = 0;
const modal = document.getElementById('episodeDetailModal');
const modalTitle = document.getElementById('modalTitle');
const modalMeta = document.getElementById('modalMeta');
const modalLoading = document.getElementById('modalLoading');
const modalBody = document.getElementById('modalBody');
const modalShowNotes = document.getElementById('modalShowNotes');
const modalTranscriptMatches = document.getElementById('modalTranscriptMatches');
const transcriptMatchCount = document.getElementById('transcriptMatchCount');
const transcriptSection = document.getElementById('transcriptSection');
const modalEpisodeLink = document.getElementById('modalEpisodeLink');

async function openEpisodeModal(episodeId, query) {
    lastScrollPosition = window.scrollY;

    // Reset modal state
    modalLoading.style.display = 'block';
    modalBody.style.display = 'none';
    modalTitle.textContent = 'Loading...';
    modalMeta.textContent = '';
    modalEpisodeLink.href = `/episodes/${episodeId}`;

    // Show modal
    modal.showModal();

    try {
        const response = await fetch(`/api/search/episode-detail/${episodeId}?q=${encodeURIComponent(query)}`);
        if (!response.ok) {
            throw new Error('Failed to load episode details');
        }

        const data = await response.json();

        // Update header
        modalTitle.textContent = data.title;
        const date = data.published_at ? data.published_at.substring(0, 10) : '';
        modalMeta.textContent = `${data.feed_title}${date ? ' â€” ' + date : ''}`;

        // Update show notes
        if (data.description) {
            modalShowNotes.innerHTML = sanitizeHtml(data.description);
        } else {
            modalShowNotes.innerHTML = '<p style="color: var(--muted-color); font-style: italic;">No show notes available.</p>';
        }

        // Update transcript matches
        if (data.transcript_matches && data.transcript_matches.length > 0) {
            transcriptSection.style.display = 'block';
            transcriptMatchCount.textContent = data.transcript_matches.length;
            modalTranscriptMatches.innerHTML = data.transcript_matches.map(match => {
                const minutes = Math.floor(match.segment_start / 60);
                const seconds = Math.floor(match.segment_start % 60);
                const timestamp = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                const ts = Math.floor(match.segment_start);
                return `
                    <div class="transcript-match">
                        <a href="/episodes/${episodeId}?t=${ts}" class="match-timestamp">[${timestamp}]</a>
                        <span class="match-text">${match.snippet}</span>
                    </div>
                `;
            }).join('');
        } else {
            transcriptSection.style.display = 'none';
        }

        // Show content
        modalLoading.style.display = 'none';
        modalBody.style.display = 'block';

    } catch (error) {
        console.error('Error loading episode details:', error);
        modalLoading.innerHTML = '<p style="color: var(--del-color);">Failed to load episode details.</p>';
    }
}

function closeEpisodeModal() {
    modal.close();
    window.scrollTo(0, lastScrollPosition);
}

// Close modal on backdrop click
modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeEpisodeModal();
    }
});

// Close modal on Escape key
modal.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeEpisodeModal();
    }
});

// Simple HTML sanitizer (allows basic formatting tags)
function sanitizeHtml(html) {
    const allowedTags = ['a', 'p', 'br', 'strong', 'b', 'em', 'i', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4'];
    const div = document.createElement('div');
    div.innerHTML = html;

    // Remove disallowed tags but keep their content
    const allElements = div.querySelectorAll('*');
    allElements.forEach(el => {
        if (!allowedTags.includes(el.tagName.toLowerCase())) {
            el.replaceWith(...el.childNodes);
        } else {
            // Remove all attributes except href on links
            const attrs = Array.from(el.attributes);
            attrs.forEach(attr => {
                if (!(el.tagName.toLowerCase() === 'a' && attr.name === 'href')) {
                    el.removeAttribute(attr.name);
                }
            });
            // Make links open in new tab
            if (el.tagName.toLowerCase() === 'a') {
                el.setAttribute('target', '_blank');
                el.setAttribute('rel', 'noopener noreferrer');
            }
        }
    });

    return div.innerHTML;
}
</script>
{% endblock %}
