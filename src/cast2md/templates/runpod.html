{% extends "admin_base.html" %}

{% block title %}RunPod - Admin - cast2md{% endblock %}

{% block content %}
<div class="page-header">
    <hgroup>
        <h1>RunPod GPU Workers</h1>
        <p>On-demand GPU transcription pods</p>
    </hgroup>
</div>

{% if not runpod_status.available %}
<!-- Not Configured Message -->
<article>
    <h4>RunPod Not Configured</h4>
    <p>To enable RunPod GPU workers, set your API key:</p>
    <pre><code>RUNPOD_API_KEY=...   # From https://runpod.io/console/user/settings</code></pre>
    <p>Server URL/IP are auto-detected. Tailscale auth key should be stored in <a href="https://www.runpod.io/console/user/secrets" target="_blank">RunPod Secrets</a> as <code>ts_auth_key</code>.</p>
    <p style="margin-top: 1rem;">
        <a href="https://console.runpod.io/deploy" target="_blank" rel="noopener">Open RunPod Console</a>
    </p>
</article>
{% else %}

<!-- Master Switch -->
<article>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <label style="display: flex; align-items: center; gap: 0.75rem; margin: 0; cursor: pointer;">
                <input type="checkbox" id="runpod-enabled-toggle" role="switch" {% if runpod_status.enabled %}checked{% endif %}>
                <span style="font-weight: 600;">RunPod Enabled</span>
            </label>
            <small style="color: var(--pico-muted-color); display: block; margin-top: 0.25rem;">
                {% if runpod_status.enabled %}
                GPU workers can be started manually or via auto-scale
                {% else %}
                Enable to use RunPod GPU workers for transcription
                {% endif %}
            </small>
        </div>
        <a href="https://console.runpod.io/deploy" target="_blank" rel="noopener" class="secondary outline" role="button" style="font-size: 0.875rem;">
            RunPod Console
        </a>
    </div>
</article>

{% if runpod_status.enabled %}
<!-- Status Overview (only when enabled) -->
<article>
    <div class="stats-grid" style="margin-bottom: 0;">
        <div class="stat-card">
            <h3>{{ runpod_status.active_pods | length }}</h3>
            <p>Active Pods</p>
        </div>
        <div class="stat-card">
            <h3>{{ runpod_status.setup_states | length }}</h3>
            <p>Starting</p>
        </div>
        <div class="stat-card">
            <h3>{{ runpod_status.max_pods }}</h3>
            <p>Max Pods</p>
        </div>
        <div class="stat-card">
            <h3>{{ transcribe_queued }}{% if settings.runpod_auto_scale %} / {{ settings.runpod_scale_threshold }}{% endif %}</h3>
            <p>{% if settings.runpod_auto_scale %}Queue / Threshold{% else %}Queued Jobs{% endif %}</p>
        </div>
    </div>
</article>

<!-- Actions -->
<article>
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <button id="start-pod-btn" {% if not runpod_status.can_create %}disabled{% endif %}>
            Start New Pod
        </button>
        <button id="terminate-all-btn" class="secondary" {% if not runpod_status.active_pods and not runpod_status.setup_states %}disabled{% endif %}>
            Terminate All
        </button>
        {% if not runpod_status.can_create and runpod_status.can_create_reason %}
        <span style="color: var(--pico-muted-color); font-size: 0.875rem;">{{ runpod_status.can_create_reason }}</span>
        {% endif %}
    </div>
</article>

<!-- Active Pods -->
{% if runpod_status.active_pods or runpod_status.setup_states %}
<article>
    <h4>Pods</h4>
    <table>
        <thead>
            <tr>
                <th>Name / Instance</th>
                <th>Status</th>
                <th>GPU</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for state in runpod_status.setup_states %}
            <tr>
                <td>
                    <strong>{{ state.pod_name or state.instance_id }}</strong>
                    <br><small style="color: var(--pico-muted-color);">{{ state.ts_hostname }}</small>
                </td>
                <td>
                    <span class="status-badge status-{{ state.phase }}">{{ state.phase }}</span>
                    {% if state.message %}
                    <br><small style="color: var(--pico-muted-color);">{{ state.message }}</small>
                    {% endif %}
                    {% if state.error %}
                    <br><small style="color: #ef4444;">{{ state.error }}</small>
                    {% endif %}
                </td>
                <td>{{ state.gpu_type or '-' }}</td>
                <td>
                    {% if state.pod_id %}
                    <button class="secondary outline small terminate-btn" data-pod-id="{{ state.pod_id }}">Terminate</button>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% for pod in runpod_status.active_pods %}
            <tr>
                <td>
                    <strong>{{ pod.name }}</strong>
                    <br><small style="color: var(--pico-muted-color);">{{ pod.id }}</small>
                </td>
                <td>
                    <span class="status-badge status-{{ pod.status | lower }}">{{ pod.status }}</span>
                </td>
                <td>{{ pod.gpu_type }}</td>
                <td>
                    <button class="secondary outline small terminate-btn" data-pod-id="{{ pod.id }}">Terminate</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% else %}
<article>
    <p style="text-align: center; color: var(--pico-muted-color);">No active pods. Click "Start New Pod" to create one.</p>
</article>
{% endif %}

<!-- Settings -->
<article>
    <header style="display: flex; justify-content: space-between; align-items: center;">
        <h4 style="margin: 0;">Settings</h4>
        <button type="button" id="save-settings-btn" class="outline">Save Settings</button>
    </header>
    <div class="grid" style="margin-top: 1rem;">
        <label>
            GPU Type
            <div style="display: flex; gap: 0.5rem;">
                <select id="setting-gpu-type" name="runpod_gpu_type" style="flex: 1;">
                    {% for gpu in gpu_types %}
                    <option value="{{ gpu.id }}" {% if gpu.id == settings.runpod_gpu_type %}selected{% endif %}>
                        {{ gpu.display_name }}{% if gpu.memory_gb %} ({{ gpu.memory_gb }}GB){% endif %}{% if gpu.price_hr %} - ${{ "%.2f"|format(gpu.price_hr) }}/hr{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <button type="button" id="refresh-gpus-btn" class="outline secondary" style="padding: 0.5rem; width: auto;" title="Refresh GPU prices">↻</button>
            </div>
            <small>Sorted by price - fallback uses next cheapest available</small>
        </label>
        <label>
            Whisper Model
            <select id="setting-whisper-model" name="runpod_whisper_model">
                {% for model in ['large-v3-turbo', 'large-v3', 'large-v2', 'medium', 'small'] %}
                <option value="{{ model }}" {% if model == settings.runpod_whisper_model %}selected{% endif %}>{{ model }}</option>
                {% endfor %}
            </select>
            <small>Transcription model for GPU pods</small>
        </label>
    </div>
    <div class="grid">
        <label>
            Max Pods
            <input type="number" id="setting-max-pods" name="runpod_max_pods" value="{{ settings.runpod_max_pods }}" min="1" max="10">
            <small>Maximum concurrent GPU pods</small>
        </label>
        <label>
            Scale Threshold
            <input type="number" id="setting-scale-threshold" name="runpod_scale_threshold" value="{{ settings.runpod_scale_threshold }}" min="1" max="100" {% if not settings.runpod_auto_scale %}disabled{% endif %}>
            <small>Start pods when queue exceeds this</small>
        </label>
    </div>
    <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
        <input type="checkbox" id="setting-auto-scale" name="runpod_auto_scale" role="switch" {% if settings.runpod_auto_scale %}checked{% endif %}>
        Auto-scale
    </label>
    <small style="display: block; margin-top: -0.5rem; color: var(--pico-muted-color);">Automatically start pods when queue grows</small>

    <hr style="margin: 1.5rem 0 1rem;">
    <div style="color: var(--pico-muted-color); font-size: 0.875rem;">
        <strong>Server:</strong> {{ runpod_status.server_url or 'Not detected' }} &nbsp;|&nbsp;
        <strong>IP:</strong> {{ runpod_status.server_ip or 'Not detected' }}
    </div>
</article>

<!-- Pod Run History -->
<article>
    <header style="display: flex; justify-content: space-between; align-items: center;">
        <h4 style="margin: 0;">Run History (30 days)</h4>
        {% if pod_run_stats %}
        <div style="color: var(--pico-muted-color); font-size: 0.875rem;">
            {{ pod_run_stats.total_runs }} runs &bull;
            {{ pod_run_stats.total_hours }}h &bull;
            ${{ "%.2f"|format(pod_run_stats.total_cost) }} total
        </div>
        {% endif %}
    </header>
    {% if pod_runs %}
    <table>
        <thead>
            <tr>
                <th>Pod</th>
                <th>GPU</th>
                <th>Duration</th>
                <th>Cost</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for run in pod_runs %}
            <tr>
                <td>
                    <strong>{{ run.pod_name }}</strong>
                    <br><small style="color: var(--pico-muted-color);">{{ run.started_at.strftime('%Y-%m-%d %H:%M') if run.started_at else '-' }}</small>
                </td>
                <td>{{ run.gpu_type }}{% if run.gpu_price_hr %}<br><small style="color: var(--pico-muted-color);">${{ "%.2f"|format(run.gpu_price_hr) }}/hr</small>{% endif %}</td>
                <td>
                    {% if run.ended_at and run.started_at %}
                    {% set duration_seconds = (run.ended_at - run.started_at).total_seconds() %}
                    {% set hours = (duration_seconds // 3600) | int %}
                    {% set minutes = ((duration_seconds % 3600) // 60) | int %}
                    {{ hours }}h {{ minutes }}m
                    {% elif run.status == 'running' %}
                    <span style="color: var(--pico-primary);">Running...</span>
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td>{% if run.cost is not none %}${{ "%.2f"|format(run.cost) }}{% else %}-{% endif %}</td>
                <td>
                    <span class="status-badge status-{{ run.status }}">{{ run.status }}</span>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="text-align: center; color: var(--pico-muted-color);">No pod runs recorded yet. Start a pod to begin tracking costs.</p>
    {% endif %}
</article>

{% else %}
<!-- Disabled state - show settings but greyed out -->
<article style="opacity: 0.6;">
    <p style="text-align: center; color: var(--pico-muted-color); margin-bottom: 1rem;">
        RunPod is disabled. Enable it above to manage GPU workers.
    </p>
    <header style="display: flex; justify-content: space-between; align-items: center;">
        <h4 style="margin: 0;">Settings</h4>
        <button type="button" id="save-settings-btn" class="outline">Save Settings</button>
    </header>
    <div class="grid" style="margin-top: 1rem;">
        <label>
            GPU Type
            <div style="display: flex; gap: 0.5rem;">
                <select id="setting-gpu-type" name="runpod_gpu_type" style="flex: 1;">
                    {% for gpu in gpu_types %}
                    <option value="{{ gpu.id }}" {% if gpu.id == settings.runpod_gpu_type %}selected{% endif %}>
                        {{ gpu.display_name }}{% if gpu.memory_gb %} ({{ gpu.memory_gb }}GB){% endif %}{% if gpu.price_hr %} - ${{ "%.2f"|format(gpu.price_hr) }}/hr{% endif %}
                    </option>
                    {% endfor %}
                </select>
                <button type="button" id="refresh-gpus-btn" class="outline secondary" style="padding: 0.5rem; width: auto;" title="Refresh GPU prices">↻</button>
            </div>
            <small>Sorted by price - fallback uses next cheapest available</small>
        </label>
        <label>
            Whisper Model
            <select id="setting-whisper-model" name="runpod_whisper_model">
                {% for model in ['large-v3-turbo', 'large-v3', 'large-v2', 'medium', 'small'] %}
                <option value="{{ model }}" {% if model == settings.runpod_whisper_model %}selected{% endif %}>{{ model }}</option>
                {% endfor %}
            </select>
            <small>Transcription model for GPU pods</small>
        </label>
    </div>
    <div class="grid">
        <label>
            Max Pods
            <input type="number" id="setting-max-pods" name="runpod_max_pods" value="{{ settings.runpod_max_pods }}" min="1" max="10">
            <small>Maximum concurrent GPU pods</small>
        </label>
        <label>
            Scale Threshold
            <input type="number" id="setting-scale-threshold" name="runpod_scale_threshold" value="{{ settings.runpod_scale_threshold }}" min="1" max="100" {% if not settings.runpod_auto_scale %}disabled{% endif %}>
            <small>Start pods when queue exceeds this</small>
        </label>
    </div>
    <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
        <input type="checkbox" id="setting-auto-scale" name="runpod_auto_scale" role="switch" {% if settings.runpod_auto_scale %}checked{% endif %}>
        Auto-scale
    </label>
    <small style="display: block; margin-top: -0.5rem; color: var(--pico-muted-color);">Automatically start pods when queue grows</small>

    <hr style="margin: 1.5rem 0 1rem;">
    <div style="color: var(--pico-muted-color); font-size: 0.875rem;">
        <strong>Server:</strong> {{ runpod_status.server_url or 'Not detected' }} &nbsp;|&nbsp;
        <strong>IP:</strong> {{ runpod_status.server_ip or 'Not detected' }}
    </div>
</article>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
<style>
    .status-creating, .status-starting, .status-connecting, .status-installing {
        background: color-mix(in srgb, var(--pico-primary) 15%, transparent);
        color: var(--pico-primary);
        border: 1px solid color-mix(in srgb, var(--pico-primary) 40%, transparent);
    }
    .status-ready, .status-running, .status-completed {
        background: color-mix(in srgb, #22c55e 15%, transparent);
        color: #22c55e;
        border: 1px solid color-mix(in srgb, #22c55e 40%, transparent);
    }
    .status-failed, .status-exited, .status-error {
        background: color-mix(in srgb, #ef4444 15%, transparent);
        color: #ef4444;
        border: 1px solid color-mix(in srgb, #ef4444 40%, transparent);
    }
    button.small {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Master switch toggle
    const enabledToggle = document.getElementById('runpod-enabled-toggle');
    if (enabledToggle) {
        enabledToggle.addEventListener('change', async function() {
            const enabled = this.checked;
            this.disabled = true;

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: { runpod_enabled: enabled ? 'true' : 'false' } })
                });

                if (response.ok) {
                    // Reload page to show updated state
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast('Error: ' + (data.detail || 'Failed to update'), 'error');
                    this.checked = !enabled;
                    this.disabled = false;
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                this.checked = !enabled;
                this.disabled = false;
            }
        });
    }

    const startBtn = document.getElementById('start-pod-btn');
    const terminateAllBtn = document.getElementById('terminate-all-btn');

    // Start pod
    if (startBtn) {
        startBtn.addEventListener('click', async function() {
            if (!await showConfirm('Start a new RunPod GPU worker?', 'Start Pod', 'Start')) return;

            startBtn.disabled = true;
            startBtn.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/runpod/pods', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showToast('Pod creation started: ' + data.instance_id, 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showToast('Error: ' + data.detail, 'error');
                    startBtn.disabled = false;
                    startBtn.removeAttribute('aria-busy');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                startBtn.disabled = false;
                startBtn.removeAttribute('aria-busy');
            }
        });
    }

    // Terminate all
    if (terminateAllBtn) {
        terminateAllBtn.addEventListener('click', async function() {
            if (!await showConfirm('Terminate ALL running RunPod workers?', 'Terminate All', 'Terminate')) return;

            terminateAllBtn.disabled = true;
            terminateAllBtn.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/runpod/pods', { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    showToast(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('Error: ' + data.detail, 'error');
                    terminateAllBtn.disabled = false;
                    terminateAllBtn.removeAttribute('aria-busy');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                terminateAllBtn.disabled = false;
                terminateAllBtn.removeAttribute('aria-busy');
            }
        });
    }

    // Individual terminate buttons
    document.querySelectorAll('.terminate-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const podId = this.dataset.podId;
            if (!await showConfirm('Terminate this pod?', 'Terminate Pod', 'Terminate')) return;

            this.disabled = true;
            this.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/runpod/pods/' + podId, { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    showToast('Pod terminated', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('Error: ' + data.detail, 'error');
                    this.disabled = false;
                    this.removeAttribute('aria-busy');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                this.disabled = false;
                this.removeAttribute('aria-busy');
            }
        });
    });

    // Toast helper
    function showToast(message, type) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.style.cssText = 'padding: 0.75rem 1rem; background: var(--pico-card-background-color); border: 1px solid var(--pico-muted-border-color); border-radius: 0.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
        if (type === 'error') {
            toast.style.borderColor = '#ef4444';
        } else if (type === 'success') {
            toast.style.borderColor = '#22c55e';
        }
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 5000);
    }

    // Auto-scale toggle - enable/disable threshold field
    const autoScaleToggle = document.getElementById('setting-auto-scale');
    const thresholdInput = document.getElementById('setting-scale-threshold');
    if (autoScaleToggle && thresholdInput) {
        autoScaleToggle.addEventListener('change', function() {
            thresholdInput.disabled = !this.checked;
        });
    }

    // Save settings button
    const saveBtn = document.getElementById('save-settings-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', async function() {
            saveBtn.disabled = true;
            saveBtn.setAttribute('aria-busy', 'true');

            const settings = {
                runpod_gpu_type: document.getElementById('setting-gpu-type')?.value,
                runpod_whisper_model: document.getElementById('setting-whisper-model')?.value,
                runpod_max_pods: document.getElementById('setting-max-pods')?.value,
                runpod_scale_threshold: document.getElementById('setting-scale-threshold')?.value,
                runpod_auto_scale: document.getElementById('setting-auto-scale')?.checked ? 'true' : 'false',
            };

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings })
                });

                if (response.ok) {
                    showToast('Settings saved', 'success');
                } else {
                    const data = await response.json();
                    showToast('Error: ' + (data.detail || 'Failed to save'), 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.removeAttribute('aria-busy');
            }
        });
    }

    // Refresh GPU prices button
    const refreshGpusBtn = document.getElementById('refresh-gpus-btn');
    if (refreshGpusBtn) {
        refreshGpusBtn.addEventListener('click', async function() {
            refreshGpusBtn.disabled = true;
            refreshGpusBtn.setAttribute('aria-busy', 'true');
            refreshGpusBtn.textContent = '';

            try {
                const response = await fetch('/api/runpod/gpu-types/refresh', { method: 'POST' });
                const data = await response.json();

                if (response.ok && data.gpu_types) {
                    // Update the select options
                    const select = document.getElementById('setting-gpu-type');
                    const currentValue = select.value;
                    select.innerHTML = data.gpu_types.map(gpu => {
                        const price = gpu.price_hr ? ` - $${gpu.price_hr.toFixed(2)}/hr` : '';
                        const mem = gpu.memory_gb ? ` (${gpu.memory_gb}GB)` : '';
                        const selected = gpu.id === currentValue ? ' selected' : '';
                        return `<option value="${gpu.id}"${selected}>${gpu.display_name}${mem}${price}</option>`;
                    }).join('');
                    showToast(`Updated ${data.gpu_types.length} GPU types`, 'success');
                } else {
                    showToast('Error: ' + (data.detail || 'Failed to refresh'), 'error');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
            } finally {
                refreshGpusBtn.disabled = false;
                refreshGpusBtn.removeAttribute('aria-busy');
                refreshGpusBtn.textContent = '↻';
            }
        });
    }

    // Auto-refresh if pods are starting
    {% if runpod_status.setup_states %}
    setTimeout(() => window.location.reload(), 5000);
    {% endif %}
});
</script>
{% endblock %}
