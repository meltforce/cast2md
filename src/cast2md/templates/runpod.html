{% extends "admin_base.html" %}

{% block title %}RunPod - Admin - cast2md{% endblock %}

{% block content %}
<div class="page-header">
    <hgroup>
        <h1>RunPod GPU Workers</h1>
        <p>On-demand GPU transcription pods</p>
    </hgroup>
</div>

{% if not runpod_status.available %}
<!-- Not Configured Message -->
<article>
    <h4>RunPod Not Configured</h4>
    <p>To enable RunPod GPU workers, set your API key:</p>
    <pre><code>RUNPOD_API_KEY=...   # From https://runpod.io/console/user/settings</code></pre>
    <p>Server URL/IP are auto-detected. Tailscale auth key should be stored in <a href="https://www.runpod.io/console/user/secrets" target="_blank">RunPod Secrets</a> as <code>ts_auth_key</code>.</p>
    <p style="margin-top: 1rem;">
        <a href="https://console.runpod.io/deploy" target="_blank" rel="noopener">Open RunPod Console</a>
    </p>
</article>
{% else %}

<!-- Master Switch -->
<article>
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <label style="display: flex; align-items: center; gap: 0.75rem; margin: 0; cursor: pointer;">
                <input type="checkbox" id="runpod-enabled-toggle" role="switch" {% if runpod_status.enabled %}checked{% endif %}>
                <span style="font-weight: 600;">RunPod Enabled</span>
            </label>
            <small style="color: var(--pico-muted-color); display: block; margin-top: 0.25rem;">
                {% if runpod_status.enabled %}
                GPU workers can be started manually or via auto-scale
                {% else %}
                Enable to use RunPod GPU workers for transcription
                {% endif %}
            </small>
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <a href="https://console.runpod.io/deploy" target="_blank" rel="noopener" class="secondary outline" role="button" style="font-size: 0.875rem;">
                RunPod Console
            </a>
            <a href="/admin/settings" class="secondary outline" role="button" style="font-size: 0.875rem;">
                Settings
            </a>
        </div>
    </div>
</article>

{% if runpod_status.enabled %}
<!-- Status Overview (only when enabled) -->
<article>
    <div class="stats-grid" style="margin-bottom: 0;">
        <div class="stat-card">
            <h3>{{ runpod_status.active_pods | length }}</h3>
            <p>Active Pods</p>
        </div>
        <div class="stat-card">
            <h3>{{ runpod_status.setup_states | length }}</h3>
            <p>Starting</p>
        </div>
        <div class="stat-card">
            <h3>{{ runpod_status.max_pods }}</h3>
            <p>Max Pods</p>
        </div>
        <div class="stat-card">
            <h3>{{ transcribe_queued }}{% if settings.runpod_auto_scale %} / {{ settings.runpod_scale_threshold }}{% endif %}</h3>
            <p>{% if settings.runpod_auto_scale %}Queue / Threshold{% else %}Queued Jobs{% endif %}</p>
        </div>
    </div>
</article>

<!-- Actions -->
<article>
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <button id="start-pod-btn" {% if not runpod_status.can_create %}disabled{% endif %}>
            Start New Pod
        </button>
        <button id="terminate-all-btn" class="secondary" {% if not runpod_status.active_pods and not runpod_status.setup_states %}disabled{% endif %}>
            Terminate All
        </button>
        {% if not runpod_status.can_create and runpod_status.can_create_reason %}
        <span style="color: var(--pico-muted-color); font-size: 0.875rem;">{{ runpod_status.can_create_reason }}</span>
        {% endif %}
    </div>
</article>

<!-- Active Pods -->
{% if runpod_status.active_pods or runpod_status.setup_states %}
<article>
    <h4>Pods</h4>
    <table>
        <thead>
            <tr>
                <th>Name / Instance</th>
                <th>Status</th>
                <th>GPU</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for state in runpod_status.setup_states %}
            <tr>
                <td>
                    <strong>{{ state.pod_name or state.instance_id }}</strong>
                    <br><small style="color: var(--pico-muted-color);">{{ state.ts_hostname }}</small>
                </td>
                <td>
                    <span class="status-badge status-{{ state.phase }}">{{ state.phase }}</span>
                    {% if state.message %}
                    <br><small style="color: var(--pico-muted-color);">{{ state.message }}</small>
                    {% endif %}
                    {% if state.error %}
                    <br><small style="color: #ef4444;">{{ state.error }}</small>
                    {% endif %}
                </td>
                <td>{{ state.gpu_type or '-' }}</td>
                <td>
                    {% if state.pod_id %}
                    <button class="secondary outline small terminate-btn" data-pod-id="{{ state.pod_id }}">Terminate</button>
                    {% else %}
                    -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            {% for pod in runpod_status.active_pods %}
            <tr>
                <td>
                    <strong>{{ pod.name }}</strong>
                    <br><small style="color: var(--pico-muted-color);">{{ pod.id }}</small>
                </td>
                <td>
                    <span class="status-badge status-{{ pod.status | lower }}">{{ pod.status }}</span>
                </td>
                <td>{{ pod.gpu_type }}</td>
                <td>
                    <button class="secondary outline small terminate-btn" data-pod-id="{{ pod.id }}">Terminate</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% else %}
<article>
    <p style="text-align: center; color: var(--pico-muted-color);">No active pods. Click "Start New Pod" to create one.</p>
</article>
{% endif %}

<!-- Configuration Info -->
<article>
    <h4>Configuration</h4>
    <div class="grid">
        <div>
            <strong>GPU Type:</strong> {{ settings.runpod_gpu_type }}<br>
            <strong>Whisper Model:</strong> {{ settings.runpod_whisper_model }}<br>
            <strong>Max Pods:</strong> {{ settings.runpod_max_pods }}
        </div>
        <div>
            <strong>Auto-scale:</strong> {% if settings.runpod_auto_scale %}Enabled (threshold: {{ settings.runpod_scale_threshold }}){% else %}Disabled{% endif %}<br>
            <strong>Server:</strong> {{ runpod_status.server_url or 'Not detected' }}<br>
            <strong>IP:</strong> {{ runpod_status.server_ip or 'Not detected' }}
        </div>
    </div>
</article>

{% else %}
<!-- Disabled state - show basic info -->
<article style="opacity: 0.6;">
    <p style="text-align: center; color: var(--pico-muted-color);">
        RunPod is disabled. Enable it above to manage GPU workers.
    </p>
    <div style="text-align: center; margin-top: 1rem;">
        <strong>Configured:</strong> GPU {{ settings.runpod_gpu_type }} | Model {{ settings.runpod_whisper_model }} | Max {{ settings.runpod_max_pods }} pods
        {% if settings.runpod_auto_scale %} | Auto-scale at {{ settings.runpod_scale_threshold }} jobs{% endif %}
    </div>
</article>
{% endif %}

{% endif %}
{% endblock %}

{% block scripts %}
<style>
    .status-creating, .status-starting, .status-connecting, .status-installing {
        background: color-mix(in srgb, var(--pico-primary) 15%, transparent);
        color: var(--pico-primary);
        border: 1px solid color-mix(in srgb, var(--pico-primary) 40%, transparent);
    }
    .status-ready, .status-running {
        background: color-mix(in srgb, #22c55e 15%, transparent);
        color: #22c55e;
        border: 1px solid color-mix(in srgb, #22c55e 40%, transparent);
    }
    .status-failed, .status-exited, .status-error {
        background: color-mix(in srgb, #ef4444 15%, transparent);
        color: #ef4444;
        border: 1px solid color-mix(in srgb, #ef4444 40%, transparent);
    }
    button.small {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Master switch toggle
    const enabledToggle = document.getElementById('runpod-enabled-toggle');
    if (enabledToggle) {
        enabledToggle.addEventListener('change', async function() {
            const enabled = this.checked;
            this.disabled = true;

            try {
                const response = await fetch('/api/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings: { runpod_enabled: enabled ? 'true' : 'false' } })
                });

                if (response.ok) {
                    // Reload page to show updated state
                    window.location.reload();
                } else {
                    const data = await response.json();
                    showToast('Error: ' + (data.detail || 'Failed to update'), 'error');
                    this.checked = !enabled;
                    this.disabled = false;
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                this.checked = !enabled;
                this.disabled = false;
            }
        });
    }

    const startBtn = document.getElementById('start-pod-btn');
    const terminateAllBtn = document.getElementById('terminate-all-btn');

    // Start pod
    if (startBtn) {
        startBtn.addEventListener('click', async function() {
            if (!confirm('Start a new RunPod GPU worker?')) return;

            startBtn.disabled = true;
            startBtn.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/runpod/pods', { method: 'POST' });
                const data = await response.json();

                if (response.ok) {
                    showToast('Pod creation started: ' + data.instance_id, 'success');
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    showToast('Error: ' + data.detail, 'error');
                    startBtn.disabled = false;
                    startBtn.removeAttribute('aria-busy');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                startBtn.disabled = false;
                startBtn.removeAttribute('aria-busy');
            }
        });
    }

    // Terminate all
    if (terminateAllBtn) {
        terminateAllBtn.addEventListener('click', async function() {
            if (!confirm('Terminate ALL running RunPod workers?')) return;

            terminateAllBtn.disabled = true;
            terminateAllBtn.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/runpod/pods', { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    showToast(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('Error: ' + data.detail, 'error');
                    terminateAllBtn.disabled = false;
                    terminateAllBtn.removeAttribute('aria-busy');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                terminateAllBtn.disabled = false;
                terminateAllBtn.removeAttribute('aria-busy');
            }
        });
    }

    // Individual terminate buttons
    document.querySelectorAll('.terminate-btn').forEach(btn => {
        btn.addEventListener('click', async function() {
            const podId = this.dataset.podId;
            if (!confirm('Terminate this pod?')) return;

            this.disabled = true;
            this.setAttribute('aria-busy', 'true');

            try {
                const response = await fetch('/api/runpod/pods/' + podId, { method: 'DELETE' });
                const data = await response.json();

                if (response.ok) {
                    showToast('Pod terminated', 'success');
                    setTimeout(() => window.location.reload(), 1000);
                } else {
                    showToast('Error: ' + data.detail, 'error');
                    this.disabled = false;
                    this.removeAttribute('aria-busy');
                }
            } catch (err) {
                showToast('Error: ' + err.message, 'error');
                this.disabled = false;
                this.removeAttribute('aria-busy');
            }
        });
    });

    // Toast helper
    function showToast(message, type) {
        const container = document.getElementById('toast-container');
        if (!container) return;

        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.style.cssText = 'padding: 0.75rem 1rem; background: var(--pico-card-background-color); border: 1px solid var(--pico-muted-border-color); border-radius: 0.25rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
        if (type === 'error') {
            toast.style.borderColor = '#ef4444';
        } else if (type === 'success') {
            toast.style.borderColor = '#22c55e';
        }
        toast.textContent = message;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 5000);
    }

    // Auto-refresh if pods are starting
    {% if runpod_status.setup_states %}
    setTimeout(() => window.location.reload(), 5000);
    {% endif %}
});
</script>
{% endblock %}
