{% extends "base.html" %}

{% block title %}Feeds - cast2md{% endblock %}

{% block content %}
<div class="page-header">
    <hgroup>
        <h1>Podcast Feeds</h1>
        <p>Manage your podcast subscriptions</p>
    </hgroup>
    <div class="header-actions">
        <button onclick="showAddFeedDialog()">Add Feed</button>
    </div>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>{{ feeds|length }}</h3>
        <p>Feeds</p>
    </div>
    <div class="stat-card">
        <h3>{{ total_episodes }}</h3>
        <p>Episodes</p>
    </div>
    <div class="stat-card">
        <h3>{{ status_counts.get('completed', 0) }}</h3>
        <p>Transcribed</p>
    </div>
    <div class="stat-card">
        <h3>{{ status_counts.get('new', 0) }}</h3>
        <p>New</p>
    </div>
</div>

<article>
    {% if feeds %}
    <table>
        <thead>
            <tr>
                <th>Podcast</th>
                <th>Episodes</th>
                <th>Last Polled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for item in feeds %}
            <tr>
                <td>
                    <a href="/feeds/{{ item.feed.id }}">{{ item.feed.display_title }}</a>
                </td>
                <td>{{ item.episode_count }}</td>
                <td>
                    {% if item.feed.last_polled %}
                        {{ item.feed.last_polled.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        Never
                    {% endif %}
                </td>
                <td class="actions">
                    <button class="outline" onclick="refreshFeed({{ item.feed.id }})">Refresh</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No feeds yet. Add one to get started!</p>
    {% endif %}
</article>

<dialog id="addFeedDialog">
    <article>
        <header>
            <button aria-label="Close" rel="prev" onclick="closeAddFeedDialog()"></button>
            <h3>Add Podcast Feed</h3>
        </header>

        <input type="text" id="feedInput" placeholder="Search or enter URL" oninput="handleInput()" autocomplete="off">
        <div id="feedResults" class="itunes-search-results">
            <div class="itunes-search-empty">Type to search for podcasts</div>
        </div>
    </article>
</dialog>
{% endblock %}

{% block scripts %}
<script>
let searchTimeout = null;
let isAddingFeed = false;

function showAddFeedDialog() {
    document.getElementById('addFeedDialog').showModal();
    document.getElementById('feedInput').focus();
}

function closeAddFeedDialog() {
    document.getElementById('addFeedDialog').close();
    document.getElementById('feedInput').value = '';
    document.getElementById('feedInput').disabled = false;
    document.getElementById('feedResults').innerHTML =
        '<div class="itunes-search-empty">Type to search for podcasts</div>';
    isAddingFeed = false;
}

function isUrl(input) {
    const trimmed = input.trim().toLowerCase();
    return trimmed.startsWith('http://') ||
           trimmed.startsWith('https://') ||
           trimmed.includes('podcasts.apple.com');
}

function handleInput() {
    if (searchTimeout) clearTimeout(searchTimeout);
    const input = document.getElementById('feedInput').value.trim();

    if (!input) {
        document.getElementById('feedResults').innerHTML =
            '<div class="itunes-search-empty">Type to search for podcasts</div>';
        return;
    }

    if (isUrl(input)) {
        renderUrlOption(input);
    } else {
        searchTimeout = setTimeout(() => searchItunes(input), 300);
    }
}

function renderUrlOption(url) {
    const resultsDiv = document.getElementById('feedResults');
    resultsDiv.innerHTML = `
        <div class="feed-url-option" onclick="addFromSearch('${escapeHtml(url)}')">
            <div class="url-icon">ðŸ”—</div>
            <div class="url-info">
                <p class="url-label">Add podcast from URL</p>
                <p class="url-value">${escapeHtml(url)}</p>
            </div>
        </div>
    `;
}

async function searchItunes(query) {
    const resultsDiv = document.getElementById('feedResults');
    resultsDiv.innerHTML = '<div class="itunes-search-loading">Searching...</div>';

    try {
        const response = await fetch(`/api/itunes/search?q=${encodeURIComponent(query)}&limit=10`);
        if (!response.ok) {
            throw new Error('Search failed');
        }
        const data = await response.json();
        renderSearchResults(data.results);
    } catch (error) {
        resultsDiv.innerHTML = '<div class="itunes-search-empty">Search failed. Please try again.</div>';
    }
}

function renderSearchResults(results) {
    const resultsDiv = document.getElementById('feedResults');

    if (results.length === 0) {
        resultsDiv.innerHTML = '<div class="itunes-search-empty">No podcasts found</div>';
        return;
    }

    resultsDiv.innerHTML = results.map(r => `
        <div class="itunes-search-result" onclick="addFromSearch('${escapeHtml(r.feed_url)}')">
            ${r.artwork_url
                ? `<img src="${escapeHtml(r.artwork_url)}" alt="" onerror="this.outerHTML='<div class=\\'no-artwork\\'>ðŸŽ™</div>'">`
                : '<div class="no-artwork">ðŸŽ™</div>'
            }
            <div class="itunes-result-info">
                <p class="itunes-result-title">${escapeHtml(r.title)}</p>
                <p class="itunes-result-author">${escapeHtml(r.author)}</p>
            </div>
        </div>
    `).join('');
}

async function addFromSearch(feedUrl) {
    if (isAddingFeed) return;
    isAddingFeed = true;

    // Show loading state
    const resultsDiv = document.getElementById('feedResults');
    resultsDiv.innerHTML = '<div class="itunes-search-loading">Adding podcast...</div>';
    document.getElementById('feedInput').disabled = true;

    try {
        const response = await fetch('/api/feeds', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({url: feedUrl})
        });

        if (response.ok) {
            resultsDiv.innerHTML = '<div class="itunes-search-loading">Done! Redirecting...</div>';
            window.location.reload();
        } else {
            const data = await response.json();
            showError(data.detail);
            isAddingFeed = false;
            document.getElementById('feedInput').disabled = false;
            handleInput(); // Restore previous results
        }
    } catch (error) {
        showError(error.message);
        isAddingFeed = false;
        document.getElementById('feedInput').disabled = false;
        handleInput();
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function refreshFeed(feedId) {
    try {
        const response = await fetch(`/api/feeds/${feedId}/refresh`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}
</script>
{% endblock %}
