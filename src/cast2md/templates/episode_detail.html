{% extends "base.html" %}

{% block title %}{{ episode.title }} - cast2md{% endblock %}

{% block content %}
{% set back_params = [] %}
{% if back_query %}{% set _ = back_params.append('q=' ~ back_query|urlencode) %}{% endif %}
{% if back_status %}{% set _ = back_params.append('status=' ~ back_status) %}{% endif %}
{% if back_per_page and back_per_page != 25 %}{% set _ = back_params.append('per_page=' ~ back_per_page) %}{% endif %}
{% if back_page and back_page != 1 %}{% set _ = back_params.append('page=' ~ back_page) %}{% endif %}
<p><a href="/feeds/{{ feed.id }}{% if back_params %}?{{ back_params|join('&') }}{% endif %}">&larr; Back to {{ feed.display_title }}</a></p>

<article class="episode-header">
    <div style="display: flex; gap: 1.5rem;">
        {% if feed.image_url %}
        <img src="{{ feed.image_url }}" alt="{{ feed.display_title }}" style="width: 150px; height: 150px; border-radius: 8px; object-fit: cover;">
        {% endif %}
        <div style="flex: 1;">
            <h1 style="margin-bottom: 0.5rem;">{{ episode.title }}</h1>
            <p style="margin-bottom: 0.5rem;">
                <a href="/feeds/{{ feed.id }}">{{ feed.display_title }}</a>
                {% if feed.author %}<span class="muted" style="color: var(--muted-color);"> by {{ feed.author }}</span>{% endif %}
            </p>
            <div class="episode-meta">
                <span class="status-badge status-{{ episode.status.value }}">{{ episode.status.value }}</span>
                &nbsp;|&nbsp;
                {{ episode.published_at.strftime('%B %d, %Y') if episode.published_at else 'Unknown date' }}
                {% if episode.duration_seconds %}
                &nbsp;|&nbsp;
                {{ '%d:%02d' % (episode.duration_seconds // 60, episode.duration_seconds % 60) }}
                {% endif %}
            </div>
            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                {% if episode.link %}
                <a href="{{ episode.link }}" target="_blank" role="button" class="outline secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Original Episode</a>
                {% endif %}
                {% if feed.link %}
                <a href="{{ feed.link }}" target="_blank" role="button" class="outline secondary" style="padding: 0.25rem 0.75rem; font-size: 0.875rem;">Podcast Website</a>
                {% endif %}
            </div>
        </div>
    </div>
</article>

{% if episode.description %}
<article>
    <header><h3>Show Notes</h3></header>
    <div class="shownotes-preview" style="color: var(--secondary); margin-bottom: 1rem;">
        {{ episode.description|truncate_html(300) }}
    </div>
    <button class="outline secondary" onclick="document.getElementById('shownotesModal').showModal()">
        Read full show notes
    </button>
</article>

<dialog id="shownotesModal">
    <article style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
        <header>
            <button aria-label="Close" rel="prev" onclick="this.closest('dialog').close()"></button>
            <h3>Show Notes</h3>
        </header>
        <div class="shownotes">
            {{ episode.description|sanitize_html|safe }}
        </div>
    </article>
</dialog>
{% endif %}

<article>
    <header>
        <h3>Actions</h3>
    </header>

    <div class="actions" style="gap: 1rem;">
        {% if episode.status.value == 'new' %}
            <button onclick="queueTranscriptDownload({{ episode.id }})">Try Transcript Download</button>
            <button class="outline secondary" onclick="queueProcess({{ episode.id }})">Download Audio</button>
        {% elif episode.status.value == 'awaiting_transcript' %}
            <button onclick="queueProcess({{ episode.id }})">Download Audio</button>
        {% elif episode.status.value == 'needs_audio' %}
            <button onclick="queueProcess({{ episode.id }})">Download Audio</button>
        {% elif episode.status.value == 'audio_ready' %}
            <button onclick="queueTranscribe({{ episode.id }})">Queue Transcription</button>
        {% elif episode.status.value == 'failed' %}
            <button onclick="queueProcess({{ episode.id }})" class="secondary">Retry</button>
        {% endif %}

        {% if episode.audio_path %}
            <a href="{{ episode.audio_url }}" target="_blank" role="button" class="outline secondary">Download Original</a>
        {% endif %}

        {# Audio management: Only show when transcript exists #}
        {% if episode.transcript_path %}
            {% if episode.audio_path %}
                <button class="outline secondary" onclick="confirmDeleteAudio({{ episode.id }})">Delete Audio</button>
            {% elif episode.audio_url and episode.status.value == 'completed' %}
                <button class="outline secondary" onclick="queueDownloadAudio({{ episode.id }})">Download Audio</button>
            {% endif %}
        {% endif %}
    </div>

    {% if episode.error_message %}
    <footer>
        <details open>
            <summary>Error Details</summary>
            <pre>{{ episode.error_message }}</pre>
        </details>
    </footer>
    {% endif %}
</article>

{% if transcript_content %}
<article>
    <header style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0;">
            Transcript
            {% if episode.transcript_source %}
                {% if episode.transcript_source.startswith('podcast2.0') %}
                <span style="font-size: 0.75rem; font-weight: normal; color: var(--muted-color);" title="Downloaded from {{ episode.transcript_url }}">(Publisher provided)</span>
                {% elif episode.transcript_source == 'pocketcasts' %}
                <span style="font-size: 0.75rem; font-weight: normal; color: var(--muted-color);" title="Auto-generated by Pocket Casts">(Auto-generated)</span>
                {% elif episode.transcript_source == 'whisper' %}
                <span style="font-size: 0.75rem; font-weight: normal; color: var(--muted-color);">(Created by cast2md{% if episode.transcript_model %} - {{ episode.transcript_model }}{% endif %})</span>
                {% endif %}
            {% elif episode.transcript_model %}
            <span style="font-size: 0.75rem; font-weight: normal; color: var(--muted-color);">({{ episode.transcript_model }})</span>
            {% endif %}
        </h3>
        <div style="display: flex; gap: 0.5rem;">
            <a href="/api/episodes/{{ episode.id }}/transcript?format=md" role="button" class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">MD</a>
            <a href="/api/episodes/{{ episode.id }}/transcript?format=txt" role="button" class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">TXT</a>
            <a href="/api/episodes/{{ episode.id }}/transcript?format=srt" role="button" class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">SRT</a>
            <a href="/api/episodes/{{ episode.id }}/transcript?format=vtt" role="button" class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">VTT</a>
            <a href="/api/episodes/{{ episode.id }}/transcript?format=json" role="button" class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;">JSON</a>
        </div>
    </header>
    <div class="transcript-container" id="transcript">
        {{ transcript_content|render_transcript|safe }}
    </div>
    {% set is_external_transcript = episode.transcript_source and (episode.transcript_source.startswith('podcast2.0') or episode.transcript_source == 'pocketcasts') %}
    {% if not is_external_transcript and current_model and (not episode.transcript_model or episode.transcript_model != current_model) %}
    <footer style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--muted-border-color);">
        <button class="outline secondary" onclick="confirmRetranscribe({{ episode.id }}, '{{ current_model }}')">
            Re-transcribe with {{ current_model }}
        </button>
    </footer>
    {% endif %}
</article>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
async function queueProcess(episodeId) {
    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/process`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

async function queueTranscriptDownload(episodeId) {
    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/transcript-download`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

async function queueTranscribe(episodeId) {
    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/transcribe`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

async function confirmRetranscribe(episodeId, currentModel) {
    if (!confirm(`Re-transcribe this episode using "${currentModel}"?\n\nThis will replace the existing transcript.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/retranscribe`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

async function confirmDeleteAudio(episodeId) {
    if (!confirm('Delete the audio file for this episode?\n\nThe transcript will be preserved and you can re-download the audio later if needed.')) {
        return;
    }

    try {
        const response = await fetch(`/api/episodes/${episodeId}/audio`, {method: 'DELETE'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

async function queueDownloadAudio(episodeId) {
    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/process`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            showSuccess(data.message);
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showError(data.detail);
        }
    } catch (error) {
        showError(error.message);
    }
}

// Timestamp navigation
document.addEventListener('DOMContentLoaded', function() {
    const params = new URLSearchParams(window.location.search);
    const timestamp = params.get('t');

    if (timestamp) {
        const targetId = 'ts-' + Math.floor(parseFloat(timestamp));
        const element = document.getElementById(targetId);

        if (element) {
            // Small delay to ensure layout is complete
            setTimeout(() => {
                element.scrollIntoView({ behavior: 'instant', block: 'center' });
                element.classList.add('highlight');
                setTimeout(() => {
                    element.classList.remove('highlight');
                }, 2000);
            }, 100);
        }
    }
});
</script>
{% endblock %}
