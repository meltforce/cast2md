{% extends "base.html" %}

{% block title %}Status - cast2md{% endblock %}

{% block content %}
<hgroup>
    <h1>System Status</h1>
    <p>Overview of episode processing</p>
</hgroup>

<div style="margin-bottom: 1rem;">
    <button onclick="queueAllPending()">Queue All Pending</button>
    <button class="secondary" onclick="cancelAllQueued()">Cancel All Queued</button>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <h3>{{ feed_count }}</h3>
        <p>Feeds</p>
    </div>
    <div class="stat-card">
        <h3>{{ status_counts.get('pending', 0) }}</h3>
        <p>Pending</p>
    </div>
    <div class="stat-card">
        <h3>{{ queue_status.download_queue.queued + queue_status.transcribe_queue.queued }}</h3>
        <p>Queued</p>
    </div>
    <div class="stat-card">
        <h3>{{ queue_status.download_queue.running + queue_status.transcribe_queue.running }}</h3>
        <p>Running</p>
    </div>
    <div class="stat-card">
        <h3>{{ status_counts.get('completed', 0) }}</h3>
        <p>Completed</p>
    </div>
    <div class="stat-card">
        <h3>{{ status_counts.get('failed', 0) }}</h3>
        <p>Failed</p>
    </div>
</div>

<!-- Worker Status -->
<article>
    <header>
        <h3>Workers
            {% if queue_status.running %}
            <span class="status-badge status-completed">Running</span>
            {% else %}
            <span class="status-badge status-failed">Stopped</span>
            {% endif %}
        </h3>
    </header>
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ queue_status.download_workers }}</h3>
            <p>Download Workers</p>
            {% for item in running_downloads %}
            <small style="display:block; margin-top:0.5rem;">
                <span class="status-badge status-downloading">DL</span>
                <a href="/episodes/{{ item.episode.id }}">{{ item.episode.title[:30] }}{% if item.episode.title|length > 30 %}...{% endif %}</a>
                <span class="elapsed" data-started="{{ item.job.started_at.isoformat() }}Z"></span>
            </small>
            {% endfor %}
        </div>
        <div class="stat-card">
            <h3>{{ queue_status.transcribe_workers }}</h3>
            <p>Transcription Workers</p>
            {% for item in running_transcriptions %}
            <small style="display:block; margin-top:0.5rem;">
                <span class="status-badge status-transcribing">TX</span>
                <a href="/episodes/{{ item.episode.id }}">{{ item.episode.title[:30] }}{% if item.episode.title|length > 30 %}...{% endif %}</a>
                <span class="elapsed" data-started="{{ item.job.started_at.isoformat() }}Z"></span>
            </small>
            {% endfor %}
        </div>
    </div>
</article>

{% if queue_status.distributed_enabled and queue_status.coordinator %}
<!-- Remote Nodes Status -->
<article>
    <header>
        <h3>Remote Transcriber Nodes
            {% if queue_status.coordinator.running %}
            <span class="status-badge status-completed">Coordinating</span>
            {% else %}
            <span class="status-badge status-failed">Inactive</span>
            {% endif %}
        </h3>
    </header>
    <div class="stats-grid">
        <div class="stat-card">
            <h3>{{ queue_status.coordinator.total_nodes }}</h3>
            <p>Total Nodes</p>
        </div>
        <div class="stat-card">
            <h3>{{ queue_status.coordinator.online_nodes }}</h3>
            <p>Online</p>
        </div>
        <div class="stat-card">
            <h3>{{ queue_status.coordinator.busy_nodes }}</h3>
            <p>Busy</p>
        </div>
        <div class="stat-card">
            <h3>{{ queue_status.coordinator.offline_nodes }}</h3>
            <p>Offline</p>
        </div>
    </div>

    {% if queue_status.coordinator.nodes %}
    <table style="margin-top: 1rem;">
        <thead>
            <tr>
                <th>Node</th>
                <th>Status</th>
                <th>Current Job</th>
                <th>Last Heartbeat</th>
            </tr>
        </thead>
        <tbody>
            {% for node in queue_status.coordinator.nodes %}
            <tr>
                <td><strong>{{ node.name }}</strong></td>
                <td>
                    {% if node.status == 'online' %}
                    <span class="status-badge status-completed">online</span>
                    {% elif node.status == 'busy' %}
                    <span class="status-badge status-downloading">busy</span>
                    {% else %}
                    <span class="status-badge status-failed">offline</span>
                    {% endif %}
                </td>
                <td>{% if node.current_job_id %}Job #{{ node.current_job_id }}{% else %}-{% endif %}</td>
                <td>{% if node.last_heartbeat %}{{ node.last_heartbeat }}{% else %}Never{% endif %}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p style="margin-top: 1rem;">No nodes registered. Add nodes via <a href="/settings">Settings</a> or using the CLI.</p>
    {% endif %}
</article>
{% endif %}

{% if running_downloads or running_transcriptions %}
<article>
    <header><h3>Currently Processing</h3></header>
    <table>
        <thead>
            <tr><th>Episode</th><th>Task</th><th>Status</th></tr>
        </thead>
        <tbody>
            {% for item in running_downloads %}
            <tr>
                <td><a href="/episodes/{{ item.episode.id }}">{{ item.episode.title }}</a></td>
                <td>Download</td>
                <td><span class="status-badge status-downloading">running</span></td>
            </tr>
            {% endfor %}
            {% for item in running_transcriptions %}
            <tr>
                <td><a href="/episodes/{{ item.episode.id }}">{{ item.episode.title }}</a></td>
                <td>Transcription</td>
                <td><span class="status-badge status-transcribing">running</span></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}

{% if queued_downloads %}
<article>
    <header><h3>Download Queue ({{ queued_downloads|length }})</h3></header>
    <table>
        <thead>
            <tr><th>Priority</th><th>Episode</th><th>Actions</th></tr>
        </thead>
        <tbody>
            {% for item in queued_downloads %}
            <tr>
                <td>{{ item.job.priority }}</td>
                <td><a href="/episodes/{{ item.episode.id }}">{{ item.episode.title }}</a></td>
                <td>
                    <button class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                            onclick="cancelJob({{ item.job.id }})">Cancel</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}

{% if queued_transcriptions %}
<article>
    <header><h3>Transcription Queue ({{ queued_transcriptions|length }})</h3></header>
    <table>
        <thead>
            <tr><th>Priority</th><th>Episode</th><th>Actions</th></tr>
        </thead>
        <tbody>
            {% for item in queued_transcriptions %}
            <tr>
                <td>{{ item.job.priority }}</td>
                <td><a href="/episodes/{{ item.episode.id }}">{{ item.episode.title }}</a></td>
                <td>
                    <button class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                            onclick="cancelJob({{ item.job.id }})">Cancel</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}

{% if downloaded %}
<article>
    <header><h3>Ready for Transcription ({{ downloaded|length }})</h3></header>
    <table>
        <thead>
            <tr><th>Episode</th><th>Actions</th></tr>
        </thead>
        <tbody>
            {% for ep in downloaded %}
            <tr>
                <td><a href="/episodes/{{ ep.id }}">{{ ep.title }}</a></td>
                <td>
                    <button class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                            onclick="queueTranscribe({{ ep.id }})">Queue Transcription</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}

{% if failed %}
<article>
    <header><h3>Failed ({{ failed|length }})</h3></header>
    <table>
        <thead>
            <tr><th>Episode</th><th>Error</th><th>Actions</th></tr>
        </thead>
        <tbody>
            {% for ep in failed %}
            <tr>
                <td><a href="/episodes/{{ ep.id }}">{{ ep.title }}</a></td>
                <td class="truncate">{{ ep.error_message or 'Unknown error' }}</td>
                <td>
                    <button class="outline secondary" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                            onclick="queueProcess({{ ep.id }})">Retry</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}

{% if pending %}
<article>
    <header><h3>Pending Download (showing {{ pending|length }})</h3></header>
    <table>
        <thead>
            <tr><th>Episode</th><th>Actions</th></tr>
        </thead>
        <tbody>
            {% for ep in pending %}
            <tr>
                <td><a href="/episodes/{{ ep.id }}">{{ ep.title }}</a></td>
                <td>
                    <button class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.875rem;"
                            onclick="queueProcess({{ ep.id }})">Queue Download</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</article>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Update elapsed time displays
function formatElapsed(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = Math.floor(seconds % 60);
    if (h > 0) return `${h}h ${m}m ${s}s`;
    if (m > 0) return `${m}m ${s}s`;
    return `${s}s`;
}

function updateElapsedTimes() {
    document.querySelectorAll('.elapsed').forEach(el => {
        const started = new Date(el.dataset.started);
        const elapsed = (Date.now() - started.getTime()) / 1000;
        el.textContent = '(' + formatElapsed(elapsed) + ')';
    });
}

updateElapsedTimes();
setInterval(updateElapsedTimes, 1000);

async function queueProcess(episodeId) {
    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/process`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error: ' + data.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function queueTranscribe(episodeId) {
    try {
        const response = await fetch(`/api/queue/episodes/${episodeId}/transcribe`, {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error: ' + data.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function cancelJob(jobId) {
    if (!confirm('Cancel this job?')) {
        return;
    }

    try {
        const response = await fetch(`/api/queue/${jobId}`, {method: 'DELETE'});
        const data = await response.json();

        if (response.ok) {
            window.location.reload();
        } else {
            alert('Error: ' + data.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function queueAllPending() {
    if (!confirm('Queue all pending episodes for processing?')) {
        return;
    }

    try {
        const response = await fetch('/api/queue/batch/all/process', {method: 'POST'});
        const data = await response.json();

        if (response.ok) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function cancelAllQueued() {
    if (!confirm('Cancel all queued jobs?')) {
        return;
    }

    try {
        const response = await fetch('/api/queue/batch/queued', {method: 'DELETE'});
        const data = await response.json();

        if (response.ok) {
            alert(data.message);
            window.location.reload();
        } else {
            alert('Error: ' + data.detail);
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Auto-refresh every 10 seconds if there are running jobs
{% if running_downloads or running_transcriptions or queued_downloads or queued_transcriptions %}
setTimeout(() => window.location.reload(), 10000);
{% endif %}
</script>
{% endblock %}
